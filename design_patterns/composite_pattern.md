---
title: 组合模式及其在Apache IoTDB中的应用
description: IoTDB的树型数据模型
---

## 组合模式原理

### 模式动机

-  对于树形结构，当容器对象（如文件夹）的某一个方法被调用时，将遍历整个树形结构，寻找也包含这个方法的成员对象（可以是容器对象，也可以是叶子对象，如子文件夹和文件）并调用执行。（递归调用）

- 由于容器对象和叶子对象在功能上的区别，在使用这些对象的客户端代码中必须有区别地对待容器对象和叶子对象，而实际上大多数情况下客户端希望一致地处理它们，因为对于这些对象的区别对待将会使得程序非常杂。
- 组合模式描述了如何将容器对象和叶子对象进行递归组合，使得用户在使用时无须对它们进行区分，可以一致地对待容器对象和叶子对象，这就是组合模式的模式动机。

### 模式定义

- 组合模式(Composite Pattern)：组合多个对象形成树形结构以表示“整体-部分”的结构层次。组合模式对单个对象（即叶子对象）和组合对象（即容器对象）的使用具有一致性。 

- 组合模式又可以称为“整体-部分”(Part-Whole)模 式，属于对象的结构模式，它将对象组织到树结构中，可以用来描述整体与部分的关系。 

### 模式结构

组合模式包含如下角色：

- Component: 抽象构件
- Leaf: 叶子构件
- Composite: 容器构件 
- Client: 客户类

![composite_pattern](/picture/composite_pattern.png)

### 模式分析

- 组合模式的关键是定义了一个抽象构件类，它既可以代表叶子，又可以代表容器，而客户端针对该抽象构件类进行编程，无须知道它到底表示的是叶子还是容器，可以对其进行统一处理。 

- 同时容器对象与抽象构件类之间还建立一个聚合关联关系，在容器对象中既可以包含叶子，也可以包含容器，以此实现递归组合，形成一个树形结构。

优点

- 可以清楚地定义分层次的复杂对象，表示对象的全部或部分层次，使得增加新构件也更容易
- 客户端调用简单，客户端可以一致地使用组合结构或其中单个对象
- 定义了包含叶子对象和容器对象的类层次结构，叶子对象可以被组合成更复杂的容器对象，而这个容器对象又可以被组合，这样不断递归下去，可以形成复杂的树形结构
- 更容易在组合体内加入对象构件，客户端不必因为加入了新的对象构件而更改原有代码

缺点

- 使设计变得更加抽象，对象的业务规则如果很复杂，则实现组合模式具有很大挑战性，而且不是所有的方法都与叶子对象子类都有关联
- 增加新构件时可能会产生一些问题，很难对容器中的构件类型进行限制

### 适用环境

- 需要表示一个对象整体或部分层次，在具有整体和部分的层次结构中，希望通过一种方式忽略整体与部分的差异，可以一致地对待它们
- 让客户端能够忽略不同对象层次的变化，客户端可以针对抽象构件编程，无需关心对象层次结构的细节
- 对象的结构是动态的且复杂程度不一样，但客户需要一致地处理它们

## Apache IoTDB的元数据树

Apache IoTDB采用树形数据模型，以方便用户遵循传统的树形资产管理方式进行数据建模。

在IoTDB的元数据树中，树的节点有多种不同的类型，并且承担不同的业务职责，详情如下：

| 类型                                      | 职责                                                         |
| ----------------------------------------- | ------------------------------------------------------------ |
| 中间节点（InternalMNode）                 | 通用的元数据树中间节点，可对应实际应用场景中某一层次的管理单元 |
| 存储组节点（StorageGroupMNode）           | 特殊的中间节点，对应每个存储组，其中定义每个存储组中数据的存活时间TTL |
| 实体节点/设备节点 （EntityMNode）         | 特殊的中间节点，为叶子节点的父节点，对应实际应用场景中携带传感器的设备 |
| 物理量节点/传感器节点（MeasurementMNode） | 元数据树中的叶子节点，对应实际应用场景中的传感器，定义了传感器采集的数据的schema信息 |



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
